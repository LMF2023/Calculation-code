This is the calculation code
